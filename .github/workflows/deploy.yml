name: wxread

on:
  schedule:
    # å‡Œæ™¨ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 01:00ï¼ˆUTC å‰ä¸€å¤© 17:00ï¼‰
    - cron: '0 17 * * *'
    # æ—©é—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 05:00ï¼ˆUTC å‰ä¸€å¤© 21:00ï¼‰
    - cron: '0 21 * * *'
    # åˆé—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 11:40ï¼ˆUTC 03:40ï¼‰
    - cron: '40 3 * * *'
    # æ™šé—´ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯å¤© 22:00ï¼ˆUTC 14:00ï¼‰
    - cron: '0 14 * * *'
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: AutoRead  # æŒ‡å®šç¯å¢ƒ

    steps:

    - name: Random execution decision
      id: should_run
      run: |
        # 50% æ¦‚ç‡è·³è¿‡æ‰§è¡Œï¼ˆå¦‚æœæ˜¯å®šæ—¶è§¦å‘ï¼‰
        if [ "${{ github.event_name }}" = "schedule" ]; then
          SKIP_CHANCE=$((RANDOM % 2))
          if [ $SKIP_CHANCE -eq 0 ]; then
            echo "ğŸ² éšæœºè·³è¿‡æ­¤æ¬¡æ‰§è¡Œ"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        echo "should_run=true" >> $GITHUB_OUTPUT
        echo "âœ… ç»§ç»­æ‰§è¡Œä»»åŠ¡"

    - name: Random delay to avoid peak time
      if: steps.should_run.outputs.should_run == 'true'
      run: |
        # ç”Ÿæˆ0åˆ°30åˆ†é’Ÿçš„éšæœºå»¶è¿Ÿï¼ˆ1800ç§’ï¼‰
        DELAY=$((RANDOM % 1801))
        echo "â° éšæœºå»¶è¿Ÿæ—¶é—´: $DELAY ç§’ ($(($DELAY / 60)) åˆ† $(($DELAY % 60)) ç§’)"
        echo "ğŸ• é¢„è®¡å¼€å§‹æ—¶é—´: $(date -d "+$DELAY seconds" "+%Y-%m-%d %H:%M:%S")"
        sleep $DELAY

    - name: Set DNS to Google's DNS
      if: steps.should_run.outputs.should_run == 'true'
      run: |
        echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
        echo "nameserver 8.8.4.4" | sudo tee -a /etc/resolv.conf

    - name: Checkout repository
      if: steps.should_run.outputs.should_run == 'true'
      uses: actions/checkout@v2

    - name: Set up Python
      if: steps.should_run.outputs.should_run == 'true'
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Install dependencies
      if: steps.should_run.outputs.should_run == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install certifi==2024.8.30 charset-normalizer==3.4.0 idna==3.10 requests==2.32.3 urllib3==2.2.3

    - name: Generate random READ_NUM
      if: steps.should_run.outputs.should_run == 'true'
      id: random
      run: |
        # ç”Ÿæˆ200åˆ°300ä¹‹é—´çš„éšæœºæ•°
        READ_NUM=$((200 + RANDOM % 101))
        echo "Generated READ_NUM: $READ_NUM"
        echo "READ_NUM=$READ_NUM" >> $GITHUB_OUTPUT

    - name: Run deployment script
      if: steps.should_run.outputs.should_run == 'true'
      env:
        WXREAD_CURL_BASH: ${{ secrets.WXREAD_CURL_BASH }}
        PUSH_METHOD: ${{ secrets.PUSH_METHOD }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        READ_NUM: ${{ steps.random.outputs.READ_NUM }}  # ä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„éšæœºæ•°ï¼ˆ200-300ï¼‰

      run: |
        python main.py
        
  keepalive-job:
    name: Keepalive Workflow
    if: ${{ always() }}
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - uses: liskin/gh-workflow-keepalive@v1
